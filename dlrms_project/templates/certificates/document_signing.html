{% extends 'includes/base.html' %}
{% load static %}

{% block title %}Sign Document - DLRMS{% endblock %}

{% block extra_css %}
<style>
    .signature-container {
        position: relative;
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        min-height: 200px;
    }
    
    .signature-placeholder {
        position: absolute;
        border: 1px solid #007bff;
        background: rgba(0, 123, 255, 0.1);
        padding: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .signature-placeholder:hover {
        background: rgba(0, 123, 255, 0.2);
        transform: scale(1.05);
    }
    
    .signature-placeholder.signed {
        background: rgba(40, 167, 69, 0.1);
        border-color: #28a745;
    }
    
    .document-preview {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        min-height: 600px;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Sign Document</h1>
        <p class="mt-2 text-gray-600">Add your digital signature to this document</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Document Preview -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Document Preview</h2>
                
                <!-- Document Info -->
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-medium text-gray-900 mb-2">
                        {% if doc_type == 'certificate' %}
                            Certificate: {{ document.certificate_number }}
                        {% else %}
                            {{ document.title }}
                        {% endif %}
                    </h3>
                    <div class="text-sm text-gray-600">
                        <p>Type: {{ document.get_certificate_type_display|default:document.get_document_type_display }}</p>
                        <p>Created: {{ document.created_at|date:"F d, Y" }}</p>
                    </div>
                </div>
                
                <!-- Document Preview Area -->
                <div class="document-preview" id="documentPreview">
                    {% if document.pdf_file %}
                        <iframe src="{{ document.pdf_file.url }}" 
                                width="100%" 
                                height="600" 
                                frameborder="0"
                                class="rounded-lg">
                        </iframe>
                    {% else %}
                        <div class="text-center py-20">
                            <i class="fas fa-file-pdf text-6xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600">Document preview not available</p>
                        </div>
                    {% endif %}
                    
                    <!-- Signature Placeholders -->
                    <div class="signature-container">
                        {% for position in signature_positions %}
                        <div class="signature-placeholder" 
                             id="sig_{{ position.id }}"
                             style="left: {{ position.x }}px; top: {{ position.y }}px;"
                             onclick="requestSignature('{{ position.id }}', '{{ position.label }}')">
                            <i class="fas fa-signature mr-2"></i>
                            {{ position.label }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Signature Panel -->
        <div class="space-y-6">
            <!-- Existing Signatures -->
            {% if existing_signatures %}
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Existing Signatures</h3>
                <div class="space-y-3">
                    {% for sig in existing_signatures %}
                    <div class="p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">{{ sig.signer.get_full_name }}</p>
                                <p class="text-sm text-gray-600">{{ sig.signer.get_role_display }}</p>
                            </div>
                            <i class="fas fa-check-circle text-green-500"></i>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Signed: {{ sig.signed_at|date:"M d, Y g:i A" }}
                        </p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Signature Actions -->
            {% if can_sign %}
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Your Signature</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Signature Type
                        </label>
                        <select id="signatureType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="approval">Approval Signature</option>
                            <option value="witness">Witness Signature</option>
                            <option value="notary">Notary Signature</option>
                        </select>
                    </div>
                    
                    <button onclick="showSignatureModal()" 
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-signature mr-2"></i>
                        Add Signature
                    </button>
                </div>
            </div>
            {% else %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    You don't have permission to sign this document.
                </p>
            </div>
            {% endif %}

            <!-- Signature Instructions -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Instructions</h3>
                <ul class="space-y-2 text-sm text-gray-600">
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-0.5 mr-2"></i>
                        <span>Click on a signature placeholder to sign at that location</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-0.5 mr-2"></i>
                        <span>Draw your signature using mouse or touch</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-0.5 mr-2"></i>
                        <span>Signatures are cryptographically secured</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mt-0.5 mr-2"></i>
                        <span>All signatures are permanently recorded</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Signature Modal -->
<div id="signatureModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full">
            <div class="bg-white px-6 py-4 modal-content">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Add Digital Signature</h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Sign below with your mouse or touch device
                    </label>
                    <canvas id="signaturePad" 
                            class="border-2 border-gray-300 rounded-lg w-full" 
                            width="450" 
                            height="200">
                    </canvas>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        I certify that:
                    </label>
                    <div class="space-y-2">
                        <label class="flex items-start">
                            <input type="checkbox" id="certify1" class="mt-1 mr-2" required>
                            <span class="text-sm text-gray-600">
                                I am authorized to sign this document
                            </span>
                        </label>
                        <label class="flex items-start">
                            <input type="checkbox" id="certify2" class="mt-1 mr-2" required>
                            <span class="text-sm text-gray-600">
                                I have reviewed and agree with the document contents
                            </span>
                        </label>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button onclick="signatureManager.clear()" 
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Clear
                    </button>
                    <button onclick="signatureManager.hide()" 
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button onclick="submitSignature()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Sign Document
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include signature libraries -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="{% static 'js/signature-component.js' %}"></script>

<script>
// Initialize signature manager
document.addEventListener('DOMContentLoaded', function() {
    signatureManager.init();
});

// Current signature position
let currentSignaturePosition = null;

function requestSignature(positionId, label) {
    currentSignaturePosition = positionId;
    showSignatureModal();
}

function showSignatureModal() {
    signatureManager.show({
        documentId: '{{ document.pk }}',
        onSign: handleSignature
    });
}

async function submitSignature() {
    // Check certifications
    if (!document.getElementById('certify1').checked || 
        !document.getElementById('certify2').checked) {
        alert('Please check all certification boxes before signing.');
        return;
    }
    
    if (signatureManager.isEmpty()) {
        alert('Please draw your signature first.');
        return;
    }
    
    const signatureData = signatureManager.getSignatureData();
    const signatureType = document.getElementById('signatureType').value;
    
    try {
        const response = await fetch("{% url 'certificates:sign_document_ajax' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                doc_type: '{{ doc_type }}',
                doc_id: '{{ document.pk }}',
                signature_data: signatureData.dataUrl,
                signature_type: signatureType,
                position: {
                    id: currentSignaturePosition,
                    timestamp: signatureData.timestamp
                }
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Mark position as signed
            if (currentSignaturePosition) {
                const placeholder = document.getElementById(`sig_${currentSignaturePosition}`);
                if (placeholder) {
                    placeholder.classList.add('signed');
                    placeholder.innerHTML = '<i class="fas fa-check mr-2"></i>Signed';
                }
            }
            
            signatureManager.hide();
            showToast('Document signed successfully!', 'success');
            
            // Reload page after delay to show updated signatures
            setTimeout(() => location.reload(), 2000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('An error occurred while signing the document.', 'error');
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 3000);
}

function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}
</script>
{% endblock %}